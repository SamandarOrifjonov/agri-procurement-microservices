spring:
  application:
    name: api-gateway
  
  # Gateway Configuration
  cloud:
    gateway:
      routes:
        # Procurement Service Routes
        - id: procurement-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/procurements/**
          filters:
            - name: CircuitBreaker
              args:
                name: procurementCircuitBreaker
                fallbackUri: forward:/fallback/procurement
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: GET,POST
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
        
        # Supplier Service Routes
        - id: supplier-service
          uri: http://localhost:8085
          predicates:
            - Path=/api/suppliers/**
          filters:
            - name: CircuitBreaker
              args:
                name: supplierCircuitBreaker
                fallbackUri: forward:/fallback/supplier
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: GET,POST
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
        
        # Contract Service Routes
        - id: contract-service
          uri: http://localhost:8086
          predicates:
            - Path=/api/contracts/**
          filters:
            - name: CircuitBreaker
              args:
                name: contractCircuitBreaker
                fallbackUri: forward:/fallback/contract
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: GET,POST
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
      
      # Global CORS Configuration
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: false
      
      # Default filters for all routes
      default-filters:
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 10
            redis-rate-limiter.burstCapacity: 20
        - AddResponseHeader=X-Response-Time, ${responseTime}

# Server Configuration
server:
  port: 8080
  compression:
    enabled: true
  error:
    include-message: always

# Logging Configuration
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
  file:
    name: logs/api-gateway.log

# Management & Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  metrics:
    export:
      prometheus:
        enabled: true
  endpoint:
    gateway:
      enabled: true

# Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    instances:
      procurementCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      supplierCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
      contractCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10

# Timeout Configuration
spring.cloud.gateway.httpclient:
  connect-timeout: 5000
  response-timeout: 30s
